#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
#
# Copyright (C) 2013 droonga project
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License version 2.1 as published by the Free Software Foundation.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

require "groonga_command_converter"
require "json"
require "ostruct"
require "optparse"

options = OpenStruct.new
option_parser = OptionParser.new do |parser|
  parser.on("-i=ID", "--id=ID",
            "base id. (optional)") do |id|
    options.id = id
  end

  parser.on("-d=DATE", "--date=DATE",
            "date. (optional)") do |date|
    options.date = date
  end

  parser.on("-r=REPLYTO", "--reply-to=REPLYTO",
            "value of replyTo field.") do |reply_to|
    options.reply_to = reply_to
  end

  parser.on("-s=DATASET", "--dataset=DATASET",
            "dataset.") do |dataset|
    options.dataset = dataset
  end
end
args = option_parser.parse!(ARGV)

if options.reply_to.nil?
  raise "You must specify the value of the \"replyTo\" field by --reply-to option."
end
if options.dataset.nil?
  raise "You must specify the name of the dataset by --dataset option."
end

convert_options = {
  :id => options.id,
  :date => options.date,
  :reply_to => options.reply_to,
  :dataset => options.dataset,
}
converter = Droonga::GroongaCommandConverter.new(convert_options)

source_file = args[0]
result_file = args[1]

input = nil
if source_file.nil?
  input = STDIN.read
else
  input = File.read(source_file)
end

result_file = args[1]

if result_file.nil?
  converter.convert(input) do |command|
    puts(JSON.generate(command))
  end
else
  File.open("w", result_file) do |file|
    converter.convert(input) do |command|
      file.puts(JSON.generate(command))
    end
  end
end
